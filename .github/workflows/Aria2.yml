name: Pixiv
on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * *'
    
jobs:
  Pixiv-Main:
    runs-on: ubuntu-latest
    outputs:
      gif-check: ${{ steps.gif-check.outputs.GIF_CONTROL }}

    steps:                          
    - name: checkout main
      uses: actions/checkout@v2
      with:
        ref: main
        fetch-depth: full
               
    - name: Prepare
      run: |
        pip install pycryptodome
        sudo apt update
        sudo apt install -y -qq aria2
        python C.py --public "${{ secrets.PUBLIC }}" --private "${{ secrets.PRIVATE }}" --mode jiemi --type rclone
        
    - name: Run
      continue-on-error: true
      run: |
        python aria.py -uid ${{ secrets.UID }} -c ${{ secrets.COOKIE }} --tag 未分類
        cd image
        bash ../retry.sh aria2c -c --input-file=urllist.txt --continue=true --conditional-get=true --allow-overwrite=false --auto-file-renaming=false  \
          --header='accept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8' \
          --header='accept-language: zh-CN,zh;q=0.9,zh-TW;q=0.8,en;q=0.7,ja;q=0.6,eo;q=0.5' \
          --header='cache-control: no-cache' \
          --header='dnt: 1' \
          --header='pragma: no-cache' \
          --header='priority: i' \
          --header='referer: https://www.pixiv.net/' \
          --header='sec-ch-ua: "Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"' \
          --header='sec-ch-ua-mobile: ?0' \
          --header='sec-ch-ua-platform: "Windows"' \
          --header='sec-fetch-dest: image' \
          --header='sec-fetch-mode: no-cors' \
          --header='sec-fetch-site: cross-site' \
          --header='sec-fetch-storage-access: none' \
          --header='user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36'
        rm -rf urllist.txt
    
    - name: Gif find
      continue-on-error: true
      run: |
        python gif.py -c ${{ secrets.COOKIE }}
        eval $(cat GIF_CONTROL)
        echo "GIF_CONTROL=$GIF_CONTROL" >> $GITHUB_OUTPUT
      id: gif-check
    
    - name: GifZIP donwload
      if:  ${{ steps.gif-check.outputs.GIF_CONTROL == 'true' }}
      run: |
        cd image
        bash ../retry.sh aria2c -c --input-file=gifs.txt --continue=true --conditional-get=true --allow-overwrite=false --auto-file-renaming=false  \
          --header='accept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8' \
          --header='accept-language: zh-CN,zh;q=0.9,zh-TW;q=0.8,en;q=0.7,ja;q=0.6,eo;q=0.5' \
          --header='cache-control: no-cache' \
          --header='dnt: 1' \
          --header='pragma: no-cache' \
          --header='priority: i' \
          --header='referer: https://www.pixiv.net/' \
          --header='sec-ch-ua: "Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"' \
          --header='sec-ch-ua-mobile: ?0' \
          --header='sec-ch-ua-platform: "Windows"' \
          --header='sec-fetch-dest: image' \
          --header='sec-fetch-mode: no-cors' \
          --header='sec-fetch-site: cross-site' \
          --header='sec-fetch-storage-access: none' \
          --header='user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36'
        rm -rf gifs.txt
      
    - name: Upload tmp Imgae
      if:  ${{ steps.gif-check.outputs.GIF_CONTROL == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.run_id }}
        path: image
        retention-days: 1
    
    - name: Upload
      if:  ${{ steps.gif-check.outputs.GIF_CONTROL == 'false' }}
      run: |
        sudo -v ; curl https://rclone.org/install.sh | sudo bash
        bash rclone.sh -p "Upload/Pixiv/image"

    - name: Clean
      if:  ${{ steps.gif-check.outputs.GIF_CONTROL == 'false' }}
      run: |
        rm -rf image
        python C.py --public "${{ secrets.PUBLIC }}" --private "${{ secrets.PRIVATE }}" --mode jiami --type rclone

    - name: Push
      if:  ${{ steps.gif-check.outputs.GIF_CONTROL == 'false' }}
      run: |
        git init
        git config user.name github-actions[bot]
        git config user.email 41898282+github-actions[bot]@users.noreply.github.com
        git add rclone.conf
        git commit -m "Daily update ${{ github.run_id }}"
        #git checkout -- Upload/oa.json
        git filter-branch --force --index-filter 'if [ "$GIT_COMMIT" != "$(git rev-parse HEAD)" ]; then git rm --cached --ignore-unmatch rclone.conf; fi' --prune-empty --tag-name-filter cat -- --all
        git push origin --force --all
  
  Pixiv-GIF:
    needs: Pixiv-Main
    if:  ${{ needs.Pixiv-Main.outputs.gif-check == 'true' }}
    uses: ./.github/workflows/Gif.yml
    with:
      upload-path: Upload/Pixiv/image
      artifact-path: ${{ github.run_id }}
    secrets: inherit
